# 实现计划: 食谱智能推荐

## 概述

本实现计划将食谱智能推荐功能分解为一系列可执行的编码任务。每个任务都是独立的、可测试的，并且按照依赖关系排序。

## 任务列表

- [x] 1. 创建推荐响应DTO和辅助类
  - 创建RecipeRecommendationDTO类，包含所有推荐结果字段
  - 创建RecommendationRequest类用于封装请求参数
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [x] 1.1 为DTO类编写单元测试
  - 测试DTO的getter/setter方法
  - 测试DTO的构造函数
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [-] 2. 扩展Dao层接口和Mapper
  - [x] 2.1 在UserShicaiDao中添加查询用户有效食材的方法
    - 添加selectValidIngredientsByUserId方法
    - _需求: 1.1, 1.2_
  
  - [x] 2.2 在UserShicaiDao.xml中实现SQL查询
    - 编写SQL查询，只选择status为'new'或'used'的食材
    - 使用索引优化查询性能
    - _需求: 1.1, 1.2, 7.2, 7.3_
  
  - [ ] 2.3 编写属性测试验证有效食材过滤
    - **属性 1: 有效食材过滤**
    - **验证: 需求 1.1, 1.2**
  
  - [x] 2.4 在CaipuxinxiDao中添加查询所有食谱的方法
    - 添加selectAllRecipesWithIngredients方法
    - _需求: 7.1, 7.2_
  
  - [x] 2.5 在CaipuxinxiDao.xml中实现SQL查询
    - 编写SQL查询，一次性获取所有食谱数据
    - 避免N+1查询问题
    - _需求: 7.1, 7.2, 7.3_

- [-] 3. 实现核心推荐算法
  - [x] 3.1 实现匹配度计算方法
    - 在Service层实现calculateMatchRate方法
    - 计算公式: (已拥有食材数 / 总需求食材数) * 100
    - _需求: 2.1, 2.4_
  
  - [-] 3.2 编写属性测试验证匹配度计算
    - **属性 2: 匹配度计算正确性**
    - **验证: 需求 2.1, 2.4**
  
  - [x] 3.3 实现过敏原过滤方法
    - 在Service层实现containsAllergen方法
    - 实现不区分大小写的匹配
    - _需求: 4.1, 4.2, 4.4_
  
  - [x] 3.4 编写属性测试验证过敏原过滤
    - **属性 3: 过敏原排除**
    - **验证: 需求 4.2**
  
  - [ ] 3.5 编写属性测试验证大小写不敏感匹配
    - **属性 10: 过敏原匹配不区分大小写**
    - **验证: 需求 4.4**
  
  - [x] 3.6 实现食材匹配识别方法
    - 识别用户拥有的所需食材
    - 识别用户缺少的所需食材
    - _需求: 2.2, 2.3_
  
  - [ ] 3.7 编写属性测试验证缺失食材计数
    - **属性 6: 缺失食材计数**
    - **验证: 需求 2.3, 3.3**

- [-] 4. 实现排序和优先级标记
  - [x] 4.1 实现排序策略方法
    - 实现按匹配度排序
    - 实现按热度排序
    - _需求: 3.1, 3.4_
  
  - [ ] 4.2 编写属性测试验证匹配度排序
    - **属性 4: 匹配度排序**
    - **验证: 需求 3.1**
  
  - [x] 4.3 实现高优先级标记逻辑
    - 匹配度≥60%标记为高优先级
    - 匹配度<60%包含缺失食材数量
    - _需求: 3.2, 3.3_
  
  - [ ] 4.4 编写属性测试验证高优先级标记
    - **属性 5: 高优先级标记**
    - **验证: 需求 3.2**

- [-] 5. 实现Service层推荐方法
  - [x] 5.1 在CaipuxinxiService接口中添加getRecommendations方法
    - 定义方法签名
    - 添加JavaDoc注释
    - _需求: 5.3_
  
  - [x] 5.2 在CaipuxinxiServiceImpl中实现getRecommendations方法
    - 整合所有算法组件
    - 实现完整的推荐流程
    - 处理边缘情况（无食材、无食谱等）
    - _需求: 1.3, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 4.1, 4.2, 4.3_
  
  - [x] 5.3 实现分页逻辑
    - 使用PageUtils进行分页
    - 返回分页元数据
    - _需求: 8.1, 8.2, 8.3_
  
  - [ ] 5.4 编写属性测试验证分页一致性
    - **属性 7: 分页一致性**
    - **验证: 需求 8.1, 8.2**
  
  - [ ] 5.5 编写单元测试验证边缘情况
    - 测试用户无有效食材的情况
    - 测试无匹配食谱的情况
    - 测试用户不存在的情况
    - _需求: 1.3_

- [-] 6. 实现Controller层接口
  - [x] 6.1 在CaipuxinxiController中添加recommend方法
    - 添加@RequestMapping注解
    - 定义请求参数
    - 实现参数验证
    - _需求: 5.1, 5.2, 5.4, 5.5, 5.6_
  
  - [x] 6.2 实现参数验证逻辑
    - 验证userId不为空
    - 设置默认值（pageNum=1, pageSize=10）
    - _需求: 5.2, 5.4, 5.5_
  
  - [ ] 6.3 编写属性测试验证参数验证
    - **属性 8: 参数验证**
    - **验证: 需求 5.2**
  
  - [x] 6.4 实现响应格式化
    - 使用R类封装响应
    - 确保兼容现有系统格式
    - _需求: 6.7_
  
  - [ ] 6.5 编写属性测试验证响应数据完整性
    - **属性 9: 响应数据完整性**
    - **验证: 需求 6.1, 6.2, 6.3, 6.4, 6.5, 6.6**
  
  - [x] 6.6 实现异常处理
    - 捕获并处理各种异常
    - 返回适当的HTTP状态码和错误消息
    - _需求: 5.2_

- [ ] 7. 检查点 - 确保所有测试通过
  - 运行所有单元测试和属性测试
  - 确保代码编译无错误
  - 如有问题，请向用户询问

- [ ] 8. 编写集成测试
  - [ ] 8.1 编写端到端推荐流程测试
    - 创建测试数据（用户、食材、食谱）
    - 调用推荐接口
    - 验证返回结果的正确性
    - _需求: 所有需求_
  
  - [ ] 8.2 编写性能测试
    - 测试大量数据下的查询性能
    - 验证无N+1查询问题
    - _需求: 7.1, 7.2, 7.3_

- [x] 9. 添加日志和监控
  - [x] 9.1 添加关键操作日志
    - 记录推荐请求的用户ID
    - 记录推荐结果数量
    - 记录异常情况
    - _需求: 所有需求_
  
  - [x] 9.2 添加性能监控点
    - 记录接口响应时间
    - 记录数据库查询时间
    - _需求: 7.1, 7.2, 7.3_

- [ ] 10. 最终检查点 - 完整功能验证
  - 确保所有测试通过
  - 手动测试推荐接口
  - 验证所有需求都已实现
  - 如有问题，请向用户询问

## 注意事项

1. **任务标记说明**:
   - 所有任务都是必需的，包括测试任务
   - 确保每个任务完成后都通过相应的测试

2. **测试策略**:
   - 属性测试应运行至少100次迭代
   - 每个属性测试必须引用设计文档中的属性编号
   - 单元测试关注特定示例和边缘情况

3. **代码风格**:
   - 遵循现有代码的命名规范
   - 添加适当的JavaDoc注释
   - 保持代码简洁，避免过度设计

4. **性能考虑**:
   - 优先使用JOIN而不是多次查询
   - 在应用层进行匹配度计算
   - 考虑添加缓存（可选）

5. **错误处理**:
   - 所有异常都应被捕获并转换为适当的HTTP响应
   - 提供清晰的错误消息
   - 记录详细的错误日志

# 实现计划：过期提醒与保质期参考库模块

## 概述

本实现计划将过期提醒与保质期参考库模块的设计转化为可执行的开发任务。按照Controller → Service → DAO的顺序，逐步实现两个核心模块和一个定时任务组件。

## 任务列表

- [x] 1. 实现ExpiryReminderService服务层
  - 实现提醒查询、状态管理、创建和删除等核心业务逻辑
  - 实现权限验证和数据验证
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.4, 2.5, 6.2, 6.3, 6.4_

- [x] 1.1 编写ExpiryReminderService的属性测试

  - **属性1: 用户提醒隔离** - 验证查询返回的提醒都属于指定用户
  - **属性6: 已读状态更新** - 验证标记已读后状态正确更新
  - **属性8: 权限验证** - 验证用户不能操作他人的提醒
  - **验证: 需求 1.1, 2.1, 2.4**

- [ ]* 1.2 编写ExpiryReminderService的单元测试
  - 测试分页查询逻辑
  - 测试状态过滤功能
  - 测试提醒创建和删除
  - 测试边界条件和异常情况
  - _需求: 1.1, 1.2, 1.3, 2.1, 2.2_

- [x] 2. 实现ExpiryReminderDao的Mapper XML
  - 编写查询提醒详情的SQL（关联user_shicai表）
  - 编写查询未读提醒数量的SQL
  - 添加必要的数据库索引建议
  - _需求: 1.4, 6.1_

- [ ]* 2.1 编写ExpiryReminderDao的属性测试
  - **属性4: 提醒详情完整性** - 验证查询详情包含关联的食材信息
  - **验证: 需求 1.4, 6.1**

- [x] 3. 实现ExpiryReminderController控制器
  - 实现分页查询接口（/page）
  - 实现查询详情接口（/info/{id}）
  - 实现标记已读接口（/markAsRead）
  - 实现删除接口（/delete）
  - 实现查询未读数量接口（/unreadCount）
  - 实现手动触发定时任务接口（/triggerCheck）
  - 添加参数验证和权限控制
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 7.1, 7.2, 7.3, 7.4_

- [ ]* 3.1 编写ExpiryReminderController的集成测试
  - 使用MockMvc测试所有REST接口
  - 测试参数验证
  - 测试响应格式
  - 测试权限控制
  - _需求: 7.1, 7.2, 7.3, 7.4_

- [x] 4. Checkpoint - 提醒模块基础功能验证
  - 确保所有测试通过，询问用户是否有问题


- [x] 5. 实现ShicaiShelfLifeService服务层
  - 实现保质期参考库的查询、添加、更新、删除逻辑
  - 实现数据验证（必填字段、保质期天数>0）
  - 实现唯一性检查（同一食材ID不能重复）
  - _需求: 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 5.1 编写ShicaiShelfLifeService的属性测试
  - **属性18: 保质期数据验证** - 验证非法数据被拒绝
  - **属性19: 保质期更新一致性** - 验证更新后数据正确
  - **属性20: 保质期删除完整性** - 验证删除后记录不存在
  - **验证: 需求 5.1, 5.2, 5.3, 5.5**

- [ ]* 5.2 编写ShicaiShelfLifeService的单元测试
  - 测试数据验证逻辑
  - 测试CRUD操作
  - 测试唯一性约束
  - 测试边界条件
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 6. 实现ShicaiShelfLifeDao的Mapper XML
  - 编写根据食材ID查询的SQL
  - 添加必要的数据库索引建议
  - _需求: 4.4_

- [ ]* 6.1 编写ShicaiShelfLifeDao的属性测试
  - **属性17: 食材ID查询唯一性** - 验证查询返回唯一记录或空
  - **验证: 需求 4.4**

- [x] 7. 实现ShicaiShelfLifeController控制器
  - 实现分页查询接口（/page）
  - 实现根据食材ID查询接口（/getByShicaiId/{shicaiId}）
  - 实现查询详情接口（/info/{id}）
  - 实现添加接口（/save）
  - 实现更新接口（/update）
  - 实现删除接口（/delete）
  - 实现查询所有接口（/list）
  - 添加参数验证
  - _需求: 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 7.1, 7.2, 7.3, 7.4_

- [ ]* 7.1 编写ShicaiShelfLifeController的集成测试
  - 使用MockMvc测试所有REST接口
  - 测试参数验证
  - 测试响应格式
  - _需求: 7.1, 7.2, 7.3, 7.4_

- [x] 8. Checkpoint - 保质期模块基础功能验证
  - 确保所有测试通过，询问用户是否有问题

- [x] 9. 实现ExpiryReminderScheduledTask定时任务
  - 创建定时任务组件类
  - 实现每天凌晨12点执行的定时方法（@Scheduled注解，cron = "0 0 0 * * ?"）
  - 实现扫描"new"状态食材的逻辑
  - 实现3天内过期提醒创建逻辑
  - 实现已过期食材处理逻辑（创建提醒+更新状态）
  - 实现提醒去重检查（避免重复创建）
  - 添加任务开始和结束日志
  - 添加性能监控（执行时长>30秒记录警告）
  - 添加异常处理（捕获异常不影响系统）
  - 实现手动触发方法（用于测试）
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 9.1, 9.3, 9.4, 9.5_

- [ ]* 9.1 编写定时任务的属性测试
  - **属性10: 定时任务扫描范围** - 验证只扫描"new"状态食材
  - **属性11: 即将过期提醒创建** - 验证3天内过期食材创建提醒
  - **属性12: 过期食材处理** - 验证过期食材创建提醒并更新状态
  - **属性13: 提醒去重** - 验证不会创建重复提醒
  - **属性14: 定时任务异常隔离** - 验证异常不影响系统
  - **验证: 需求 3.1, 3.2, 3.3, 3.4, 3.6**

- [ ]* 9.2 编写定时任务的单元测试
  - 测试扫描逻辑
  - 测试提醒创建条件判断
  - 测试去重逻辑
  - 测试异常处理
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.6_

- [x] 10. 实现UserShicaiController的级联操作
  - 修改delete方法，添加删除关联提醒的逻辑
  - 修改update方法，添加状态联动逻辑（status变为used/discarded时删除待处理提醒）
  - 修改update方法，添加过期日期联动逻辑（expiryDate变化时更新提醒日期）
  - 添加@Transactional注解确保事务一致性
  - _需求: 6.2, 6.3, 6.4, 8.5_

- [ ]* 10.1 编写级联操作的属性测试
  - **属性21: 食材删除级联** - 验证删除食材时提醒也被删除
  - **属性22: 食材状态联动** - 验证状态变化时提醒被删除
  - **属性23: 过期日期联动** - 验证过期日期变化时提醒日期更新
  - **验证: 需求 6.2, 6.3, 6.4**

- [ ]* 10.2 编写级联操作的集成测试
  - 测试删除食材的级联效果
  - 测试状态更新的联动效果
  - 测试过期日期更新的联动效果
  - 测试事务回滚场景
  - _需求: 6.2, 6.3, 6.4, 8.5_

- [x] 11. Checkpoint - 定时任务和级联操作验证
  - 确保所有测试通过，询问用户是否有问题

- [x] 12. 数据库优化和配置
  - 创建数据库索引（userid、user_shicai_id、status、remind_date、shicai_id）
  - 在application.yml中添加定时任务配置
  - 验证索引创建成功
  - _需求: 10.3_

- [x] 13. 初始化保质期参考数据
  - 准备常见食材的保质期参考数据（至少20种）
  - 编写数据初始化脚本或接口
  - 执行数据导入
  - _需求: 4.1_

- [ ]* 14. 端到端集成测试
  - 测试完整的过期提醒流程（添加食材 → 定时任务扫描 → 创建提醒 → 查询提醒 → 标记已读）
  - 测试保质期参考库的完整流程（添加参考 → 查询参考 → 更新参考 → 删除参考）
  - 测试级联操作的完整流程（添加食材和提醒 → 删除食材 → 验证提醒被删除）
  - _需求: 1.1, 2.1, 3.1, 3.2, 3.3, 4.1, 5.1, 6.2_

- [ ]* 15. 性能测试
  - 测试定时任务扫描10000条食材的性能（目标<30秒）
  - 测试分页查询1000条数据的性能（目标<500ms）
  - 测试批量创建100条提醒的性能（目标<2秒）
  - _需求: 10.1, 10.2, 10.4_

- [ ] 16. 最终验证和文档
  - 运行所有测试确保通过
  - 验证代码覆盖率达标（行覆盖率≥80%）
  - 更新API文档（如果有）
  - 编写部署说明文档
  - 确保所有测试通过，询问用户是否有问题

## 注意事项

- 任务标记`*`的为可选任务，可以根据项目进度决定是否执行
- 每个Checkpoint任务是验证点，确保前面的任务都正确完成
- 属性测试使用QuickTheories框架，每个测试至少运行100次迭代
- 所有数据库操作都要考虑事务管理和异常处理
- 定时任务的cron表达式：`0 0 0 * * ?`（每天凌晨12点）
- 级联操作必须使用@Transactional注解确保数据一致性
